-- https://school.programmers.co.kr/learn/courses/30/lessons/284528
WITH SCORE_AVG AS (
  SELECT 
    E.EMP_NO,
    E.EMP_NAME,
    ROUND(AVG(E.SAL), 1) AS AVG_SALARY,
    ROUND(AVG(G.SCORE), 1) AS AVG_SCORE
  FROM HR_EMPLOYEES E
  LEFT JOIN HR_GRADE G ON E.EMP_NO = G.EMP_NO
  GROUP BY E.EMP_NO, E.EMP_NAME
)

SELECT 
  EMP_NO,
  EMP_NAME,
  CASE 
    WHEN AVG_SCORE >= 96 THEN 'S'
    WHEN AVG_SCORE >= 90 THEN 'A'
    WHEN AVG_SCORE >= 80 THEN 'B'
    ELSE 'C'
  END AS GRADE,
  CASE 
    WHEN AVG_SCORE >= 96 THEN AVG_SALARY * 0.2
    WHEN AVG_SCORE >= 90 THEN AVG_SALARY * 0.15
    WHEN AVG_SCORE >= 80 THEN AVG_SALARY * 0.1
    ELSE 0
  END AS BONUS
FROM SCORE_AVG
ORDER BY EMP_NO ASC;