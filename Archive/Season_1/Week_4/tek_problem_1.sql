-- 프로그래머스 자동차 대여 기록 별 대여 금액 구하기
-- https://school.programmers.co.kr/learn/courses/30/lessons/151141

-- WITH를 사용하여 GROUPED CTE 생성
-- 할인 적용 가능한 데이터만 따로 가져온다
WITH GROUPED AS (
    SELECT RH.HISTORY_ID, RH.CAR_ID, C.CAR_TYPE, C.DAILY_FEE, DP.DISCOUNT_RATE,
        DATEDIFF(RH.END_DATE, RH.START_DATE) + 1 AS DATE_DIFF, 
        SUBSTRING_INDEX(DP.DURATION_TYPE, "일", 1) AS START_DISCOUNT
    FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY AS RH
    LEFT JOIN CAR_RENTAL_COMPANY_CAR AS C
        ON RH.CAR_ID = C.CAR_ID
    LEFT JOIN CAR_RENTAL_COMPANY_DISCOUNT_PLAN AS DP
        ON DP.CAR_TYPE = C.CAR_TYPE
    WHERE C.CAR_TYPE = "트럭"
        -- DATE_DIFF >= START_DISCOUNT를 WHERE절에 표현
        -- 이를 통해, 할인 적용할 수 있는 HISTORY_ID를 확인할 수 있다
        AND (DATEDIFF(RH.END_DATE, RH.START_DATE) + 1) >= (SUBSTRING_INDEX(DP.DURATION_TYPE, "일", 1))
    GROUP BY RH.HISTORY_ID
)

SELECT GG.HISTORY_ID,
    -- 할인율에 따른 금액 계산 후 정수형으로 변경
    CAST(GG.DAILY_FEE * ((100 - GG.DC_RATE)/100) * GG.DATE_DIFF_ALL AS UNSIGNED) AS FEE
FROM (
    SELECT RH.HISTORY_ID, RH.CAR_ID, C.CAR_TYPE, C.DAILY_FEE,
        -- 대여 일수가 부족해 따로 할인을 적용할 수 없다면, 할인율 = 0으로 설정
        IFNULL(G.DISCOUNT_RATE, 0) AS DC_RATE,
        DATEDIFF(RH.END_DATE, RH.START_DATE) + 1 AS DATE_DIFF_ALL
    FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY AS RH
    LEFT JOIN CAR_RENTAL_COMPANY_CAR AS C
        ON RH.CAR_ID = C.CAR_ID
    -- 할인 적용 가능한 HISTORY_ID를 JOIN
    LEFT JOIN GROUPED AS G
        ON G.HISTORY_ID = RH.HISTORY_ID
    WHERE C.CAR_TYPE = "트럭"
) AS GG
ORDER BY FEE DESC, GG.HISTORY_ID DESC